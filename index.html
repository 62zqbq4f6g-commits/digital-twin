<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <meta name="description" content="Inscript ‚Äî The first AI that actually remembers you. Not just your notes ‚Äî your world.">
  <meta name="application-name" content="Inscript">
  <meta property="og:title" content="Inscript ‚Äî Your mirror in code">
  <meta property="og:description" content="The first AI that actually remembers you.">

  <title>Inscript ‚Äî Your mirror in code</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="assets/icon-192.png">
  <link rel="apple-touch-icon" href="assets/icon-192.png">

  <!-- Google Fonts - Vogue Aesthetic -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css?v=804">
  <link rel="stylesheet" href="css/design-system.css?v=804">
  <link rel="stylesheet" href="css/mirror.css?v=800">
  <link rel="stylesheet" href="css/patterns.css?v=800">
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-icon">
        <svg class="loading-spinner" viewBox="0 0 50 50">
          <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <p class="loading-text" id="loading-text">sitting with this...</p>
    </div>
  </div>

  <!-- Auth Screen (shown before app) -->
  <div id="auth-screen" class="auth-container hidden">
    <div class="auth-card">
      <!-- Brand -->
      <div class="auth-brand">
        <h1 class="auth-logo">INSCRIPT</h1>
        <p class="auth-tagline">Your mirror in code</p>
      </div>

      <!-- Sign In Form (default) -->
      <div id="auth-signin-form" class="auth-form-wrapper">
        <form class="auth-form" onsubmit="return false;">
          <div class="auth-field">
            <label class="auth-label" for="auth-signin-email">Email</label>
            <input type="email" id="auth-signin-email" class="auth-input" placeholder="you@example.com" autocomplete="email">
          </div>

          <div class="auth-field">
            <label class="auth-label" for="auth-signin-password">Password</label>
            <input type="password" id="auth-signin-password" class="auth-input" placeholder="Enter password" autocomplete="current-password">
          </div>

          <p id="auth-signin-error" class="auth-error hidden"></p>

          <button type="submit" id="auth-signin-btn" class="auth-btn">Sign in</button>
        </form>

        <p class="auth-footer">
          New here? <button id="show-signup-btn" class="auth-link">Create account</button>
        </p>
      </div>

      <!-- Sign Up Form -->
      <div id="auth-signup-form" class="auth-form-wrapper hidden">
        <form class="auth-form" onsubmit="return false;">
          <div class="auth-field">
            <label class="auth-label" for="auth-signup-email">Email</label>
            <input type="email" id="auth-signup-email" class="auth-input" placeholder="you@example.com" autocomplete="email">
          </div>

          <div class="auth-field">
            <label class="auth-label" for="auth-signup-password">Password</label>
            <input type="password" id="auth-signup-password" class="auth-input" placeholder="Min 6 characters" autocomplete="new-password">
          </div>

          <p id="auth-signup-error" class="auth-error hidden"></p>

          <button type="submit" id="auth-signup-btn" class="auth-btn">Begin</button>
        </form>

        <p class="auth-footer">
          Have an account? <button id="show-signin-btn" class="auth-link">Sign in</button>
        </p>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div id="app">
    <!-- Header -->
    <header class="header">
      <h1 class="header-title brand-logo">INSCRIPT</h1>
      <div class="header-buttons">
        <button class="header-settings-btn" id="header-settings-btn" aria-label="Settings">
          <span>‚öô</span>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Capture Screen - Phase 4C: Now a sub-screen for image capture -->
      <section id="screen-capture" class="screen hidden">
        <!-- Back button to return to notes -->
        <button id="capture-back-btn" class="capture-back-btn" aria-label="Back to notes">
          <span>‚Üê Back</span>
        </button>
        <!-- Capture Section (default view) -->
        <div id="capture-section">
          <!-- Voice button area -->
          <div class="capture-voice-area">
            <button id="voice-btn" class="voice-btn" aria-label="Start voice recording">
              <span class="voice-icon mic-icon">üé§</span>
              <div class="stop-icon"></div>
            </button>
            <p class="voice-hint">Tap to speak</p>
            <p id="transcript-display" class="transcript-display"></p>
          </div>

          <!-- Text input area -->
          <div class="capture-input-area">
            <div class="text-input-container">
              <textarea
                id="text-input"
                class="text-input"
                placeholder="What's on your mind?"
                rows="1"
                autocomplete="off"
                autocorrect="off"
                autocapitalize="off"
                spellcheck="false"
                data-lpignore="true"
                data-form-type="other"
              ></textarea>
              <button id="submit-btn" class="submit-btn" aria-label="Submit note">
                <span class="submit-icon">‚Üí</span>
              </button>
            </div>

            <!-- Image Input (hidden file input) -->
            <input type="file" id="image-input" accept="image/*" class="hidden">

            <!-- Add Media Button -->
            <button id="image-btn" class="image-add-btn">
              <span class="image-icon">üì∑</span>
              <span>Add Media</span>
            </button>
          </div>
        </div>

        <!-- Image Section (shown after image selected) -->
        <section id="image-section" class="hidden">
          <div class="image-preview-container">
            <img id="image-preview" alt="Preview">
            <button id="remove-image" class="remove-image-btn" aria-label="Remove image">‚úï</button>
          </div>

          <!-- Context input with voice option -->
          <div class="image-context-area">
            <div class="image-context-header">
              <span class="image-context-label">Add context (optional)</span>
            </div>
            <div class="image-context-input-row">
              <button id="image-voice-btn" class="image-voice-btn" aria-label="Add context via voice">
                <span class="mic-icon">üé§</span>
                <div class="stop-icon"></div>
              </button>
              <textarea
                id="image-context"
                class="image-context-input"
                placeholder="Type or tap mic to speak..."
                rows="2"
              ></textarea>
            </div>
            <p id="image-transcript-display" class="image-transcript-display"></p>
          </div>

          <button id="process-image-btn" class="btn-primary btn-full">
            Process Image
          </button>
        </section>
      </section>

      <!-- Notes Screen - Phase 4C: Now includes capture -->
      <section id="screen-notes" class="screen">
        <!-- Quick Capture Input (integrated into Notes) -->
        <div class="notes-capture-area">
          <div id="notes-image-preview" class="notes-image-preview"></div>
          <div class="notes-capture-row">
            <button id="notes-voice-btn" class="notes-voice-btn" aria-label="Voice input">
              <span class="mic-icon">üé§</span>
              <div class="stop-icon"></div>
            </button>
            <input
              type="text"
              id="notes-quick-input"
              class="notes-quick-input"
              placeholder="What's on your mind?"
            >
            <button id="notes-camera-btn" class="notes-camera-btn" aria-label="Add image">
              <span>üì∑</span>
            </button>
            <button id="notes-submit-btn" class="notes-submit-btn" aria-label="Submit">
              <span>‚Üí</span>
            </button>
          </div>
          <p id="notes-transcript-display" class="notes-transcript-display"></p>
          <!-- Quick Modes (Phase 14) -->
          <div class="notes-quick-modes">
            <button id="meeting-mode-btn" class="quick-mode-btn" aria-label="Meeting mode">
              <span class="quick-mode-icon">üìã</span>
              <span class="quick-mode-label">Meeting</span>
            </button>
            <button id="decision-mode-btn" class="quick-mode-btn" aria-label="Decision mode">
              <span class="quick-mode-icon">ü§î</span>
              <span class="quick-mode-label">Decision</span>
            </button>
          </div>
        </div>

        <!-- Search Box -->
        <div class="notes-search">
          <input
            type="text"
            id="notes-search-input"
            class="notes-search-input"
            placeholder="Search notes..."
            autocomplete="off"
          >
        </div>

        <!-- Filter Tabs -->
        <div class="notes-filters">
          <button class="filter-tab active" data-category="all">All</button>
          <button class="filter-tab" data-category="work">üíº Work</button>
          <button class="filter-tab" data-category="personal">üè† Personal</button>
          <button class="filter-tab" data-category="ideas">üí° Ideas</button>
        </div>

        <!-- Notes List -->
        <div id="notes-list" class="notes-list">
          <!-- Notes will be dynamically inserted here -->
        </div>

        <!-- Empty State -->
        <div id="notes-empty" class="notes-empty hidden">
          <p class="notes-empty-text">No notes yet. Start capturing your thoughts above.</p>
        </div>
      </section>

      <!-- Twin Screen -->
      <section id="screen-twin" class="screen hidden">
        <header class="brand-header" style="margin-bottom: var(--space-6); margin-top: var(--space-4);">
          <h2 class="brand-title">Your mirror in code</h2>
          <p class="brand-tagline">your mirror in code</p>
        </header>

        <!-- Phase 9: About You Section (populated by UIProfile) -->
        <div id="about-me-section">
          <!-- Populated by UIProfile.renderAboutYouSection() -->
        </div>

        <!-- Phase 9: Your Preferences Section (unlocks after 5 notes) -->
        <div id="preferences-section">
          <!-- Populated by UIProfile.renderPreferencesSection() -->
        </div>

        <!-- Phase 9: Your World Section (entities) -->
        <div id="your-world-section">
          <!-- Populated by Entities.renderYourWorldSection() -->
        </div>

        <!-- Phase 8: What I've Learned Section -->
        <div class="learning-section-container" id="learning-section">
          <!-- Populated by TwinUI.renderLearningSection() -->
        </div>

        <!-- 1. Thinking Through (Open Loops) -->
        <div class="twin-open-decisions" id="twin-thinking-through-section">
          <div class="twin-section-header">Thinking Through</div>
          <div id="twin-thinking-through-list">
            <p class="twin-empty">No open loops</p>
          </div>
        </div>

        <!-- 2. Phase 13: Patterns I've Noticed -->
        <div class="twin-section">
          <h3 class="twin-section-title">Patterns I've Noticed</h3>
          <div class="twin-section-content" id="twin-patterns-container">
            <p class="twin-empty">No patterns detected yet</p>
          </div>
        </div>

        <!-- 3. This Week (moved DOWN) -->
        <div class="twin-section" id="twin-this-week-section">
          <h3 class="twin-section-title">This Week</h3>
          <div class="twin-section-content" id="twin-this-week-list">
            <p class="twin-empty">No activity yet</p>
          </div>
        </div>

        <!-- Confidence Meter -->
        <div class="twin-confidence">
          <div class="twin-confidence-header">
            <span class="twin-confidence-label">Twin Confidence</span>
            <span class="twin-confidence-value" id="twin-confidence-value">0%</span>
          </div>
          <div class="twin-confidence-bar">
            <div class="twin-confidence-fill" id="twin-confidence-fill" style="width: 0%"></div>
          </div>
          <p class="twin-confidence-hint" id="twin-confidence-hint">Add more notes to help your twin learn</p>
        </div>

        <!-- Stats Grid -->
        <div class="twin-stats">
          <div class="twin-stat">
            <span class="twin-stat-value" id="twin-stat-notes">0</span>
            <span class="twin-stat-label">Notes</span>
          </div>
          <div class="twin-stat">
            <span class="twin-stat-value" id="twin-stat-decisions">0</span>
            <span class="twin-stat-label">Decisions</span>
          </div>
          <div class="twin-stat">
            <span class="twin-stat-value" id="twin-stat-patterns">0</span>
            <span class="twin-stat-label">Patterns</span>
          </div>
          <div class="twin-stat">
            <span class="twin-stat-value" id="twin-stat-feedback">0%</span>
            <span class="twin-stat-label">Positive</span>
          </div>
        </div>

        <!-- Quality Learning Stats -->
        <div class="quality-section" id="quality-stats-section">
          <div class="quality-card">
            <div class="quality-header">
              <span class="quality-title">Output Quality</span>
              <span class="quality-trend" id="quality-trend">‚Äî</span>
            </div>
            <div class="quality-bar-container">
              <div class="quality-bar" id="quality-bar" style="width: 0%"></div>
            </div>
            <div class="quality-stats-row">
              <span id="quality-liked">0 liked</span>
              <span id="quality-disliked">0 disliked</span>
            </div>
          </div>
          <div class="quality-preferences" id="quality-preferences">
            <!-- Filled by JS -->
          </div>
        </div>

        <!-- Actions -->
        <div class="twin-actions">
          <button id="twin-rebuild-btn" class="twin-action-btn">
            <span>Rebuild Profile</span>
            <span class="twin-action-desc">Re-analyze all notes</span>
          </button>
        </div>
      </section>

      <!-- MIRROR Screen - Phase 13B -->
      <section id="screen-mirror" class="screen hidden">
        <div id="mirror-container" class="mirror-container">
          <!-- Populated by Mirror.js -->
        </div>
      </section>

      <!-- WORK Screen (Phase 14 - Work Utility) -->
      <section id="screen-work" class="screen hidden">
        <!-- Sub-tab Navigation -->
        <div class="work-tabs">
          <button class="work-tab active" data-work-tab="pulse">PULSE</button>
          <button class="work-tab" data-work-tab="actions">ACTIONS</button>
          <button class="work-tab" data-work-tab="meetings">MEETINGS</button>
          <button class="work-tab" data-work-tab="commitments">COMMITMENTS</button>
        </div>

        <!-- PULSE Sub-tab (Morning Briefing) -->
        <div id="work-pulse" class="work-content">
          <div class="pulse-container">
            <p class="pulse-loading">Loading your morning pulse...</p>
          </div>
        </div>

        <!-- ACTIONS Sub-tab (existing actions functionality) -->
        <div id="work-actions" class="work-content hidden">
          <div class="actions-list" id="actions-list">
            <!-- Populated by JS -->
          </div>
          <div class="actions-empty hidden" id="actions-empty">
            <!-- Populated by JS -->
          </div>
        </div>

        <!-- MEETINGS Sub-tab -->
        <div id="work-meetings" class="work-content hidden">
          <div class="meetings-list" id="meetings-list">
            <p class="meetings-empty">No meetings recorded yet.</p>
          </div>
          <button class="meetings-add-btn" id="new-meeting-btn">
            <span>+ New Meeting</span>
          </button>
        </div>

        <!-- COMMITMENTS Sub-tab -->
        <div id="work-commitments" class="work-content hidden">
          <div class="commitments-header">
            <p class="commitments-intro">Things you said you'd do:</p>
          </div>
          <div class="commitments-list" id="commitments-list">
            <p class="commitments-empty">No open commitments.</p>
          </div>
        </div>
      </section>

      <!-- Settings Screen -->
      <section id="screen-settings" class="screen hidden">
        <!-- Account Section -->
        <div class="settings-section">
          <h2 class="settings-heading">Account</h2>
          <div class="settings-account-card" id="account-card">
            <div class="account-info">
              <span class="account-email" id="account-email">Not signed in</span>
              <span class="sync-status" id="sync-status">‚óã Offline</span>
            </div>
            <button class="account-sync-btn" id="sync-now-btn" onclick="Sync.syncNow()">‚Üª</button>
          </div>
          <div class="settings-auth-buttons" id="auth-buttons">
            <button class="settings-btn settings-btn-outline" id="sign-in-btn">
              <span>Sign In</span>
            </button>
            <p class="settings-auth-link">
              Don't have an account? <button id="sign-up-link" class="settings-link-btn">Sign Up</button>
            </p>
          </div>
        </div>

        <div class="settings-section">
          <h2 class="settings-heading">Insights</h2>
          <button id="digest-btn" class="digest-trigger-btn" onclick="Digest.generate()">
            <span>Weekly Digest</span>
          </button>
        </div>

        <div class="settings-section">
          <h2 class="settings-heading">Data</h2>
          <button id="export-all-btn" class="settings-btn">
            <span>Export All Notes</span>
            <span class="settings-btn-desc">Download backup as JSON file</span>
          </button>
        </div>

        <div class="settings-section settings-danger-zone">
          <h2 class="settings-heading">Danger Zone</h2>
          <button id="clear-data-btn" class="settings-btn settings-btn-danger">
            <span>Delete All Data</span>
            <span class="settings-btn-desc">Permanently deletes all notes, actions, and settings (including cloud)</span>
          </button>
          <button id="sign-out-btn" class="settings-btn settings-btn-danger hidden">
            <span>Sign Out</span>
            <span class="settings-btn-desc">Sign out of cloud sync</span>
          </button>
        </div>

        <div class="settings-section settings-version">
          <p class="settings-version-text">Inscript v<span id="app-version">5.3.0</span></p>
        </div>
      </section>

      <!-- Note Detail Screen (overlay) -->
      <section id="screen-note-detail" class="screen note-detail-screen hidden">
        <!-- Header with back button -->
        <div class="note-detail-header">
          <button id="note-detail-back" class="note-detail-back" aria-label="Back to notes">
            <span>‚Üê</span>
          </button>
          <div class="note-detail-category">
            <span id="note-detail-icon"></span>
            <span id="note-detail-category-label"></span>
          </div>
        </div>

        <!-- Note content -->
        <div class="note-detail-content">
          <h2 id="note-detail-title" class="note-detail-title"></h2>
          <p id="note-detail-timestamp" class="note-detail-timestamp"></p>
          <div id="note-detail-body" class="note-detail-body"></div>
        </div>

        <!-- Action buttons -->
        <div class="note-detail-actions">
          <button id="note-detail-copy" class="note-detail-btn">
            <span>Copy</span>
          </button>
          <button id="note-detail-export" class="note-detail-btn">
            <span>Export JSON</span>
          </button>
          <button id="note-detail-delete" class="note-detail-btn note-detail-btn-danger">
            <span>Delete</span>
          </button>
        </div>
      </section>
    </main>

    <!-- Delete Confirmation Dialog -->
    <div id="delete-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h3 class="dialog-title">Delete Note?</h3>
        <p class="dialog-message">This action cannot be undone.</p>
        <div class="dialog-actions">
          <button id="delete-cancel" class="dialog-btn">Cancel</button>
          <button id="delete-confirm" class="dialog-btn dialog-btn-danger">Delete</button>
        </div>
      </div>
    </div>

    <!-- Clear All Data Dialog -->
    <div id="clear-data-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h3 class="dialog-title">Clear All Data?</h3>
        <p class="dialog-message">This will permanently delete all your notes. This action cannot be undone.</p>
        <div class="dialog-actions">
          <button id="clear-data-cancel" class="dialog-btn">Cancel</button>
          <button id="clear-data-confirm" class="dialog-btn dialog-btn-danger">Clear All</button>
        </div>
      </div>
    </div>

    <!-- Auth Modal - Vogue Minimalist -->
    <div id="auth-modal" class="auth-modal hidden">
      <div class="auth-container">
        <!-- Header -->
        <div class="auth-header">
          <span class="auth-brand brand-logo">Inscript</span>
        </div>

        <!-- Close button -->
        <button id="auth-close" class="auth-close" aria-label="Close">‚úï</button>

        <!-- Sign In Form (default) -->
        <div id="auth-signin" class="auth-form">
          <div class="auth-fields">
            <div class="auth-field">
              <label class="auth-label" for="signin-email">Email</label>
              <input type="email" id="signin-email" class="auth-input" placeholder="your@email.com" autocomplete="email">
            </div>
            <div class="auth-field">
              <label class="auth-label" for="signin-password">Password</label>
              <input type="password" id="signin-password" class="auth-input" placeholder="Enter password" autocomplete="current-password">
            </div>
          </div>

          <p id="signin-error" class="auth-error hidden"></p>

          <button id="signin-submit" class="auth-submit">Sign In</button>

          <p class="auth-switch">
            New here? <button id="show-signup" class="auth-switch-btn">Create account</button>
          </p>
        </div>

        <!-- Sign Up Form -->
        <div id="auth-signup" class="auth-form hidden">
          <div class="auth-fields">
            <div class="auth-field">
              <label class="auth-label" for="signup-email">Email</label>
              <input type="email" id="signup-email" class="auth-input" placeholder="your@email.com" autocomplete="email">
            </div>
            <div class="auth-field">
              <label class="auth-label" for="signup-password">Password</label>
              <input type="password" id="signup-password" class="auth-input" placeholder="Min 6 characters" autocomplete="new-password">
            </div>
            <div class="auth-field">
              <label class="auth-label" for="signup-confirm">Confirm Password</label>
              <input type="password" id="signup-confirm" class="auth-input" placeholder="Confirm password" autocomplete="new-password">
            </div>
          </div>

          <p id="signup-error" class="auth-error hidden"></p>

          <button id="signup-submit" class="auth-submit">Begin</button>

          <p class="auth-switch">
            Have an account? <button id="show-signin" class="auth-switch-btn">Sign in</button>
          </p>
        </div>
      </div>
    </div>

    <!-- Digest Modal -->
    <div id="digest-modal" class="modal hidden">
      <div class="modal-content">
        <button class="modal-close" onclick="Digest.closeDigest()">‚úï</button>
        <div id="digest-content">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- Meeting Debrief Modal (Phase 14) -->
    <div id="meeting-modal" class="modal hidden">
      <div class="modal-content meeting-modal-content">
        <button class="modal-close" id="meeting-modal-close" aria-label="Close">‚úï</button>
        <h2 class="meeting-modal-title">Meeting Debrief</h2>

        <div class="meeting-form">
          <div class="meeting-field">
            <label class="meeting-label">Who was there?</label>
            <div class="meeting-attendees">
              <input type="text" id="meeting-attendees-input" class="meeting-input" placeholder="Add people...">
              <div id="meeting-attendees-list" class="meeting-attendees-chips"></div>
              <div id="meeting-attendees-suggestions" class="meeting-suggestions hidden"></div>
            </div>
          </div>

          <div class="meeting-field">
            <label class="meeting-label">What happened?</label>
            <div class="meeting-capture-row">
              <button id="meeting-voice-btn" class="meeting-voice-btn" aria-label="Voice input">
                <span class="mic-icon">üé§</span>
                <div class="stop-icon"></div>
              </button>
              <textarea id="meeting-content" class="meeting-textarea" placeholder="Tap mic to speak or type here..." rows="4"></textarea>
            </div>
            <p id="meeting-transcript-display" class="meeting-transcript-display"></p>
          </div>

          <button id="meeting-save-btn" class="meeting-save-btn">Save Meeting</button>
        </div>
      </div>
    </div>

    <!-- Decision Mode Modal (Phase 14) -->
    <div id="decision-modal" class="modal hidden">
      <div class="modal-content decision-modal-content">
        <button class="modal-close" id="decision-modal-close" aria-label="Close">‚úï</button>
        <h2 class="decision-modal-title">Thinking Through</h2>

        <div class="decision-form">
          <div class="decision-field">
            <label class="decision-label">What are you deciding?</label>
            <input type="text" id="decision-topic" class="decision-input" placeholder="e.g., Whether to push the launch">
          </div>

          <div class="decision-field">
            <label class="decision-label">What's on your mind?</label>
            <div class="decision-capture-row">
              <button id="decision-voice-btn" class="decision-voice-btn" aria-label="Voice input">
                <span class="mic-icon">üé§</span>
                <div class="stop-icon"></div>
              </button>
              <textarea id="decision-content" class="decision-textarea" placeholder="Tap mic to speak or type here..." rows="4"></textarea>
            </div>
            <p id="decision-transcript-display" class="decision-transcript-display"></p>
          </div>

          <button id="decision-save-btn" class="decision-save-btn">Save</button>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation - Phase 14: 4 tabs with WORK -->
    <nav class="nav nav-four-tabs">
      <button class="nav-tab active" data-screen="notes">
        <span class="nav-label">NOTES</span>
      </button>
      <button class="nav-tab" data-screen="work">
        <span class="nav-label">WORK</span>
      </button>
      <button class="nav-tab" data-screen="twin">
        <span class="nav-label">TWIN</span>
      </button>
      <button class="nav-tab" data-screen="mirror">
        <span class="nav-label">MIRROR</span>
      </button>
    </nav>
  </div>

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Scripts (v6.0.6 cache bust) -->
  <script src="js/loading-messages.js?v=800"></script>
  <script src="js/notes-cache.js?v=800"></script>
  <script src="js/db.js?v=700"></script>
  <script src="js/classifier.js?v=700"></script>
  <script src="js/extractor.js?v=802"></script>
  <script src="js/refiner.js?v=700"></script>
  <script src="js/app.js?v=700"></script>
  <script src="js/ui.js?v=792"></script>
  <script src="js/ui-chat.js?v=790"></script>
  <script src="js/ui-camera.js?v=790"></script>
  <script src="js/ui-entities.js?v=790"></script>
  <script src="js/voice.js?v=700"></script>
  <script src="js/camera.js?v=700"></script>
  <script src="js/digest.js?v=700"></script>
  <script src="js/sync.js?v=700"></script>
  <script src="js/auth.js?v=700"></script>
  <script src="js/entity-memory.js?v=700"></script>
  <script src="js/user-profile.js?v=700"></script>
  <script src="js/twin-profile.js?v=700"></script>
  <script src="js/entity-extractor.js?v=700"></script>
  <script src="js/belief-extractor.js?v=700"></script>
  <script src="js/pattern-detector.js?v=700"></script>
  <script src="js/twin-engine.js?v=700"></script>
  <script src="js/twin-ui.js?v=802"></script>
  <script src="js/quality-learning.js?v=700"></script>
  <script src="js/analyzer.js?v=700"></script>
  <script src="js/analysis-validator.js?v=700"></script>
  <script src="js/tier-detector.js?v=700"></script>
  <script src="js/output-generator.js?v=700"></script>
  <script src="js/feedback.js?v=700"></script>
  <script src="js/decision-tracker.js?v=700"></script>
  <script src="js/actions-ui.js?v=700"></script>
  <script src="js/work-ui.js?v=800"></script>
  <script src="js/follow-up.js?v=700"></script>
  <script src="js/nudge-tracker.js?v=700"></script>
  <script src="js/onboarding.js?v=792"></script>
  <script src="js/ui-profile.js?v=700"></script>
  <script src="js/entities.js?v=700"></script>
  <script src="js/embeddings.js?v=770"></script>
  <script src="js/context.js?v=700"></script>
  <script src="js/settings.js?v=700"></script>
  <script src="js/knowledge-pulse.js?v=800"></script>
  <script src="js/entity-cards.js?v=800"></script>
  <script src="js/signal-tracker.js?v=800"></script>
  <script src="js/pattern-verification.js?v=800"></script>
  <script src="js/mirror.js?v=800"></script>
  <script>
    // Environment variables - loaded from API
    window.ENV = {
      SUPABASE_URL: '',
      SUPABASE_ANON_KEY: ''
    };

    // SERVICE WORKER DISABLED - caching issues blocking beta
    // Will re-enable after beta launch with proper caching strategy
    // v5.2.0 - No caching, always fresh from server

    // Unregister ALL existing service workers and clear caches
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(reg => {
          reg.unregister();
          console.log('[App] Unregistered service worker');
        });
      });
    }

    // Clear any existing caches
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => {
          caches.delete(name);
          console.log('[App] Deleted cache:', name);
        });
      });
    }

    console.log('[App] Version: 7.0.0');

    // Main initialization - runs immediately
    (async function init() {
      // STEP 1: Fetch environment FIRST (blocking)
      console.log('Loading environment...');
      try {
        const response = await fetch('/api/env');
        if (response.ok) {
          const env = await response.json();
          window.ENV.SUPABASE_URL = env.SUPABASE_URL || '';
          window.ENV.SUPABASE_ANON_KEY = env.SUPABASE_ANON_KEY || '';
          console.log('Environment loaded:', window.ENV.SUPABASE_URL ? 'Supabase configured' : 'Supabase not configured');
        }
      } catch (error) {
        console.warn('Could not load environment:', error.message);
      }

      // STEP 2: Wait for DOM if not ready
      if (document.readyState === 'loading') {
        await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
      }

      // STEP 3: Setup Auth authenticated handler
      Auth.onAuthenticated = async function() {
        console.log('[Init] onAuthenticated called, initializing App...');

        // Initialize database FIRST
        try {
          const initPromise = App.init();
          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('App.init timeout')), 5000)
          );
          await Promise.race([initPromise, timeoutPromise]);
          console.log('[Init] App.init complete, DB.notes count:', DB.notes?.length || 0);
        } catch (e) {
          console.warn('[Init] App.init issue:', e.message);
        }

        // CRITICAL: Pull notes from cloud BEFORE checking onboarding
        // This ensures existing users see their notes on new devices
        if (typeof Sync !== 'undefined' && Sync.isAuthenticated()) {
          console.log('[Init] Pulling notes from cloud...');
          try {
            // Force full sync by clearing last sync time
            localStorage.removeItem('dt_last_sync');
            await Sync.syncNow();
            console.log('[Init] Cloud sync complete, DB.notes count:', DB.notes?.length || 0);
          } catch (e) {
            console.warn('[Init] Cloud sync failed:', e.message);
          }
        }

        // Check for onboarding (new users with no notes)
        // NOW we have cloud data in local DB
        console.log('[Init] Checking onboarding, Sync.user:', Sync.user?.email || 'none');
        if (typeof Onboarding !== 'undefined') {
          const shouldShow = await Onboarding.shouldShow();
          console.log('[Init] Onboarding.shouldShow():', shouldShow);
          if (shouldShow) {
            console.log('[App] New user detected, starting onboarding');
            Onboarding.start();
            return;
          } else {
            UI.init();
          }
        } else {
          console.log('[Init] Onboarding module not found');
          UI.init();
        }

        Voice.init();
        Camera.init();
        if (typeof UserProfile !== 'undefined') {
          await UserProfile.init();
        }
        await TwinEngine.init();
        TwinUI.init();
        Feedback.init();
        ActionsUI.init();
        setTimeout(async () => {
          if (typeof FollowUp !== 'undefined') {
            await FollowUp.checkPendingFollowUps();
          }
        }, 3000);
      };

      // STEP 4: Check authentication
      const isAuthenticated = await Auth.init();

      if (isAuthenticated) {
        // Already logged in - start the app
        console.log('[Init] Already authenticated, starting app...');
        Auth.hideAuthScreen();
        await Auth.onAuthenticated();
      } else {
        // Show auth screen
        console.log('[Init] Not authenticated, showing auth screen...');
        Auth.showAuthScreen();
        Auth.attachAuthListeners();
      }
    })();
  </script>

  <!-- Phase 9.1: Feedback Toast -->
  <div class="feedback-toast" id="feedback-toast">
    <span class="feedback-toast__text"></span>
  </div>
</body>
</html>
